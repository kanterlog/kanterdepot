/* ... (your existing HTML and CSS code, with the HTML change above) ... */

<script>
    let autoSaveTimer;
    let saveTimeout; // For debouncing auto-save

    // Initialisation
    document.addEventListener('DOMContentLoaded', function() {
        loadForm(); // Load saved data on page load
        updateProgress();
        setupAutoSave();
        setupValidation();
        setupCheckboxGroups();
    });

    // --- Utility Functions ---

    function showMessage(message, type = 'validation') {
        const validationMessage = document.getElementById('validationMessage');
        const successMessage = document.getElementById('successMessage');

        if (type === 'validation') {
            validationMessage.textContent = message;
            validationMessage.style.display = 'block';
            successMessage.style.display = 'none';
        } else if (type === 'success') {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            validationMessage.style.display = 'none';
        }
        // Hide after 5 seconds
        setTimeout(() => {
            validationMessage.style.display = 'none';
            successMessage.style.display = 'none';
        }, 5000);
    }

    function showAutoSaveIndicator() {
        const indicator = document.getElementById('autoSaveIndicator');
        indicator.classList.add('show');
        setTimeout(() => {
            indicator.classList.remove('show');
        }, 2000); // Hide after 2 seconds
    }

    function updateProgress() {
        const formElements = document.querySelectorAll('.form-input, input[type="date"], input[type="time"], input[type="checkbox"]');
        let filledFields = 0;
        let totalFields = 0;

        formElements.forEach(element => {
            // Exclude the decision checkboxes from the progress calculation
            if (element.name === 'decision') {
                return;
            }

            if (element.type === 'checkbox') {
                // For checkbox groups where at least one must be checked
                if (element.closest('.checkbox-group') || element.closest('.checkbox-group-inline')) {
                    const groupName = element.name || element.id; // Use name or ID for unique group identification
                    const groupCheckboxes = document.querySelectorAll(`input[name="${groupName}"], input[id="${groupName}"]`);
                    if (!element._countedGroup) { // Ensure group is only counted once
                         totalFields++;
                         if (Array.from(groupCheckboxes).some(cb => cb.checked)) {
                             filledFields++;
                         }
                         groupCheckboxes.forEach(cb => cb._countedGroup = true); // Mark as counted
                    }
                } else { // Individual checkboxes
                    totalFields++;
                    if (element.checked) {
                        filledFields++;
                    }
                }
            } else if (element.type === 'text' || element.type === 'number' || element.type === 'tel' || element.type === 'date' || element.type === 'time') {
                totalFields++;
                if (element.value.trim() !== '') {
                    filledFields++;
                }
            } else if (element.tagName === 'SELECT') { // Handle select elements
                totalFields++;
                if (element.value !== '') { // A value has been selected
                    filledFields++;
                }
            }
        });

        // Handle the dynamic table rows (equipe d'encadrement)
        const equipeRows = document.querySelectorAll('#equipe-tbody tr');
        equipeRows.forEach(row => {
            const qualite = row.querySelector('.equipe-qualite'); // This is now a <select>
            const nom = row.querySelector('.equipe-nom');
            const prenom = row.querySelector('.equipe-prenom');

            // Only count fields if the row isn't completely empty
            // For <select>, an empty value "" means not selected
            if (qualite.value !== '' || nom.value.trim() !== '' || prenom.value.trim() !== '') {
                totalFields += 3; // Qualité, Nom, Prénom
                if (qualite.value !== '') filledFields++; // Check value for select
                if (nom.value.trim() !== '') filledFields++;
                if (prenom.value.trim() !== '') filledFields++;
            }
        });

        const progressBar = document.getElementById('progressBar');
        const progressPercentage = totalFields > 0 ? (filledFields / totalFields) * 100 : 0;
        progressBar.style.width = progressPercentage + '%';
    }


    // --- Auto-Save and Manual Save/Load ---

    function setupAutoSave() {
        document.querySelectorAll('.form-container input, .form-container select, .form-container textarea').forEach(input => {
            input.addEventListener('input', () => { // Works for text, number, select
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => {
                    saveForm();
                    showAutoSaveIndicator();
                }, 1000); // Save 1 second after last input
                updateProgress();
            });
            input.addEventListener('change', () => { // For checkboxes, radios, dates, select
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => {
                    saveForm();
                    showAutoSaveIndicator();
                }, 1000);
                updateProgress();
            });
        });
    }

    function saveForm() {
        const formData = {};

        // General Information
        formData['maternelle'] = document.getElementById('maternelle').checked;
        formData['elementaire'] = document.getElementById('elementaire').checked;

        formData['type-sortie'] = Array.from(document.querySelectorAll('input[name="type-sortie"]:checked')).map(cb => cb.id);

        formData['nom-ecole'] = document.getElementById('nom-ecole').value;
        formData['adresse'] = document.getElementById('adresse').value;
        formData['code-postal'] = document.getElementById('code-postal').value;
        formData['commune'] = document.getElementById('commune').value;
        formData['enseignant'] = document.getElementById('enseignant').value;
        formData['telephone'] = document.getElementById('telephone').value;
        formData['date-sortie'] = document.getElementById('date-sortie').value;
        formData['nb-seances'] = document.getElementById('nb-seances').value;
        formData['heure-depart'] = document.getElementById('heure-depart').value;
        formData['heure-retour'] = document.getElementById('heure-retour').value;
        formData['lieu-rassemblement'] = document.getElementById('lieu-rassemblement').value;
        formData['lieu-sortie'] = document.getElementById('lieu-sortie').value;
        formData['restauration'] = document.getElementById('restauration').value;
        formData['classes'] = document.getElementById('classes').value;
        formData['nb-eleves'] = document.getElementById('nb-eleves').value;
        formData['nb-accompagnateurs'] = document.getElementById('nb-accompagnateurs').value;

        // Equipe d'encadrement
        const equipe = [];
        document.querySelectorAll('#equipe-tbody tr').forEach(row => {
            const qualite = row.querySelector('.equipe-qualite').value; // Get value from select
            const nom = row.querySelector('.equipe-nom').value;
            const prenom = row.querySelector('.equipe-prenom').value;
            equipe.push({ qualite, nom, prenom });
        });
        formData['equipe'] = equipe;

        // Visa Section
        formData['date-transmission'] = document.getElementById('date-transmission').value;
        formData['decision'] = Array.from(document.querySelectorAll('input[name="decision"]:checked')).map(cb => cb.id);
        formData['date-decision'] = document.getElementById('date-decision').value;

        localStorage.setItem('schoolTripForm', JSON.stringify(formData));
        updateProgress();
    }

    function loadForm() {
        const savedData = localStorage.getItem('schoolTripForm');
        if (savedData) {
            const formData = JSON.parse(savedData);

            // General Information
            document.getElementById('maternelle').checked = formData['maternelle'] || false;
            document.getElementById('elementaire').checked = formData['elementaire'] || false;

            document.querySelectorAll('input[name="type-sortie"]').forEach(cb => {
                cb.checked = formData['type-sortie'] && formData['type-sortie'].includes(cb.id);
            });

            document.getElementById('nom-ecole').value = formData['nom-ecole'] || '';
            document.getElementById('adresse').value = formData['adresse'] || '';
            document.getElementById('code-postal').value = formData['code-postal'] || '';
            document.getElementById('commune').value = formData['commune'] || '';
            document.getElementById('enseignant').value = formData['enseignant'] || '';
            document.getElementById('telephone').value = formData['telephone'] || '';
            document.getElementById('date-sortie').value = formData['date-sortie'] || '';
            document.getElementById('nb-seances').value = formData['nb-seances'] || '';
            document.getElementById('heure-depart').value = formData['heure-depart'] || '';
            document.getElementById('heure-retour').value = formData['heure-retour'] || '';
            document.getElementById('lieu-rassemblement').value = formData['lieu-rassemblement'] || '';
            document.getElementById('lieu-sortie').value = formData['lieu-sortie'] || '';
            document.getElementById('restauration').value = formData['restauration'] || '';
            document.getElementById('classes').value = formData['classes'] || '';
            document.getElementById('nb-eleves').value = formData['nb-eleves'] || '';
            document.getElementById('nb-accompagnateurs').value = formData['nb-accompagnateurs'] || '';

            // Equipe d'encadrement
            const equipeTbody = document.getElementById('equipe-tbody');
            equipeTbody.innerHTML = ''; // Clear existing rows
            if (formData['equipe'] && formData['equipe'].length > 0) {
                formData['equipe'].forEach(person => {
                    addRow(person.qualite, person.nom, person.prenom);
                });
            } else {
                addRow(); // Add at least one empty row if no data
            }


            // Visa Section
            document.getElementById('date-transmission').value = formData['date-transmission'] || '';
            document.querySelectorAll('input[name="decision"]').forEach(cb => {
                cb.checked = formData['decision'] && formData['decision'].includes(cb.id);
            });
            document.getElementById('date-decision').value = formData['date-decision'] || '';

            showMessage('Formulaire chargé avec succès !', 'success');
        } else {
            showMessage('Aucune donnée sauvegardée trouvée.', 'validation');
            // Ensure at least one row exists if no data was loaded
            if (document.querySelectorAll('#equipe-tbody tr').length === 0) {
                addRow();
            }
        }
        updateProgress();
    }

    function clearForm() {
        if (confirm('Voulez-vous vraiment effacer toutes les données du formulaire ?')) {
            document.querySelectorAll('.form-container input, .form-container select').forEach(element => { // Include select
                if (element.type === 'checkbox' || element.type === 'radio') {
                    element.checked = false;
                } else if (element.tagName === 'SELECT') {
                    element.value = ''; // Reset select to its first option (empty value)
                }
                else {
                    element.value = '';
                }
            });
            document.getElementById('equipe-tbody').innerHTML = ''; // Clear table rows
            addRow(); // Add one empty row back
            localStorage.removeItem('schoolTripForm');
            showMessage('Formulaire effacé avec succès !', 'success');
            updateProgress();
        }
    }

    // --- Dynamic Table (Equipe d'encadrement) ---

    function addRow(qualite = '', nom = '', prenom = '') {
        const tbody = document.getElementById('equipe-tbody');
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td>
                <select class="equipe-qualite form-input" required>
                    <option value="">Sélectionner une qualité</option>
                    <option value="Enseignant">Enseignant</option>
                    <option value="AESH">AESH</option>
                    <option value="Parent">Parent</option>
                    <option value="ATSEM">ATSEM</option>
                    <option value="Intervenant extérieur">Intervenant extérieur</option>
                    <option value="Autre">Autre</option>
                </select>
            </td>
            <td><input type="text" class="equipe-nom" placeholder="Nom" value="${nom}" ${nom === '' ? 'required' : ''}></td>
            <td><input type="text" class="equipe-prenom" placeholder="Prénom" value="${prenom}" ${prenom === '' ? 'required' : ''}></td>
            <td><button type="button" onclick="removeRow(this)" class="btn btn-danger btn-small">Supprimer</button></td>
        `;
        tbody.appendChild(newRow);

        // Set the selected value if provided (for loading)
        const qualiteSelect = newRow.querySelector('.equipe-qualite');
        if (qualite) {
            qualiteSelect.value = qualite;
        }

        newRow.querySelectorAll('input, select').forEach(input => { // Include select
            input.addEventListener('input', () => { // Works for select as well
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => {
                    saveForm();
                    showAutoSaveIndicator();
                }, 1000);
                updateProgress();
            });
            input.addEventListener('change', () => { // For select as well
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => {
                    saveForm();
                    showAutoSaveIndicator();
                }, 1000);
                updateProgress();
            });
        });
        updateProgress(); // Update progress bar after adding a row
    }

    function removeRow(button) {
        const tbody = document.getElementById('equipe-tbody');
        if (tbody.children.length > 1) { // Prevent removing all rows
            button.closest('tr').remove();
            saveForm(); // Save after removing a row
            updateProgress();
        } else {
            showMessage('Vous devez avoir au moins une personne dans l\'équipe d\'encadrement.', 'validation');
        }
    }

    // --- Form Validation ---

    function setupValidation() {
        const form = document.querySelector('.form-container');
        form.addEventListener('submit', function(event) {
            event.preventDefault(); // Prevent default submission
            validateForm();
        });

        document.querySelectorAll('.form-container input, .form-container select').forEach(element => { // Include select
            element.addEventListener('input', function() {
                // Clear validation message when user starts typing again
                document.getElementById('validationMessage').style.display = 'none';
                // Re-validate just this field on input to give immediate feedback
                if (!this.checkValidity()) {
                    this.style.borderColor = 'var(--danger-color)';
                } else {
                    this.style.borderColor = 'var(--border-color)';
                }
            });
            // For selects, 'change' event is more appropriate for validation feedback
            if (element.tagName === 'SELECT') {
                element.addEventListener('change', function() {
                     document.getElementById('validationMessage').style.display = 'none';
                    if (!this.checkValidity()) {
                        this.style.borderColor = 'var(--danger-color)';
                    } else {
                        this.style.borderColor = 'var(--border-color)';
                    }
                });
            }
        });
    }

    function validateForm() {
        let isValid = true;
        let errorMessage = '';

        // Check if at least one of 'Maternelle' or 'Élémentaire' is checked
        const maternelle = document.getElementById('maternelle');
        const elementaire = document.getElementById('elementaire');
        if (!maternelle.checked && !elementaire.checked) {
            errorMessage += '<li>Veuillez sélectionner au moins "Maternelle" ou "Élémentaire".</li>';
            isValid = false;
        }

        // Check if at least one 'Type de sortie' is checked
        const typeSortieCheckboxes = document.querySelectorAll('input[name="type-sortie"]');
        const isTypeSortieChecked = Array.from(typeSortieCheckboxes).some(checkbox => checkbox.checked);
        if (!isTypeSortieChecked) {
            errorMessage += '<li>Veuillez sélectionner le type de sortie.</li>';
            isValid = false;
        }

        // Validate all required input fields (text, number, date, time) and select fields
        document.querySelectorAll('.form-input[required], .table input[required], .table select[required]').forEach(element => { // Include select
            if (element.tagName === 'SELECT') {
                if (element.value === '') { // Check for empty value in select
                    isValid = false;
                    element.style.borderColor = 'var(--danger-color)'; // Highlight invalid fields
                    if (!errorMessage.includes(`Veuillez remplir tous les champs obligatoires (<span class="required">*</span>).`)) {
                        errorMessage += `<li>Veuillez remplir tous les champs obligatoires (<span class="required">*</span>).</li>`;
                    }
                } else {
                    element.style.borderColor = 'var(--border-color)';
                }
            } else if (!element.value.trim()) { // For text inputs
                isValid = false;
                element.style.borderColor = 'var(--danger-color)'; // Highlight invalid fields
                if (!errorMessage.includes(`Veuillez remplir tous les champs obligatoires (<span class="required">*</span>).`)) {
                    errorMessage += `<li>Veuillez remplir tous les champs obligatoires (<span class="required">*</span>).</li>`;
                }
            } else {
                element.style.borderColor = 'var(--border-color)';
            }
        });

        // Specific validation for Equipe d'encadrement table
        const equipeRows = document.querySelectorAll('#equipe-tbody tr');
        equipeRows.forEach((row, index) => {
            const qualite = row.querySelector('.equipe-qualite'); // This is now a <select>
            const nom = row.querySelector('.equipe-nom');
            const prenom = row.querySelector('.equipe-prenom');

            // Check if any of the fields in a row are filled, then all must be filled
            const rowHasContent = qualite.value !== '' || nom.value.trim() !== '' || prenom.value.trim() !== ''; // Check value for select

            if (rowHasContent) {
                if (qualite.value === '') { // Check value for select
                    isValid = false;
                    qualite.style.borderColor = 'var(--danger-color)';
                    if (!errorMessage.includes(`Qualité de l'équipe d'encadrement`)) {
                        errorMessage += `<li>La qualité est requise pour chaque personne de l'équipe d'encadrement remplie.</li>`;
                    }
                } else { qualite.style.borderColor = 'var(--border-color)'; }
                if (!nom.value.trim()) {
                    isValid = false;
                    nom.style.borderColor = 'var(--danger-color)';
                    if (!errorMessage.includes(`Nom de l'équipe d'encadrement`)) {
                        errorMessage += `<li>Le nom est requis pour chaque personne de l'équipe d'encadrement remplie.</li>`;
                    }
                } else { nom.style.borderColor = 'var(--border-color)'; }
                if (!prenom.value.trim()) {
                    isValid = false;
                    prenom.style.borderColor = 'var(--danger-color)';
                    if (!errorMessage.includes(`Prénom de l'équipe d'encadrement`)) {
                        errorMessage += `<li>Le prénom est requis pour chaque personne de l'équipe d'encadrement remplie.</li>`;
                    }
                } else { prenom.style.borderColor = 'var(--border-color)'; }
            }
        });

        // Check if at least one decision checkbox is checked
        const decisionCheckboxes = document.querySelectorAll('input[name="decision"]');
        const isDecisionChecked = Array.from(decisionCheckboxes).some(checkbox => checkbox.checked);
        if (!isDecisionChecked) {
            errorMessage += '<li>Veuillez indiquer la décision du directeur (Accord ou Refus).</li>';
            isValid = false;
        }


        if (!isValid) {
            document.getElementById('validationMessage').innerHTML = `<strong>Veuillez corriger les erreurs suivantes :</strong><ul>${errorMessage}</ul>`;
            document.getElementById('validationMessage').style.display = 'block';
            document.getElementById('successMessage').style.display = 'none';
        } else {
            showMessage('Formulaire validé avec succès ! Vous pouvez maintenant exporter.', 'success');
            document.getElementById('validationMessage').style.display = 'none';
        }
        return isValid;
    }

    // Handle unique selection for checkbox groups (Type de sortie and Décision du directeur)
    function setupCheckboxGroups() {
        const typeSortieCheckboxes = document.querySelectorAll('input[name="type-sortie"]');
        typeSortieCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    typeSortieCheckboxes.forEach(otherCheckbox => {
                        if (otherCheckbox !== this) {
                            otherCheckbox.checked = false;
                        }
                    });
                }
                updateProgress();
                saveForm();
            });
        });

        const decisionCheckboxes = document.querySelectorAll('input[name="decision"]');
        decisionCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    decisionCheckboxes.forEach(otherCheckbox => {
                        if (otherCheckbox !== this) {
                            otherCheckbox.checked = false;
                        }
                    });
                }
                updateProgress();
                saveForm();
            });
        });
    }

    // --- PDF Export (Requires html2pdf.js library) ---

    async function exportToPDF() {
        if (!validateForm()) {
            showMessage('Veuillez corriger les erreurs du formulaire avant d\'exporter en PDF.', 'validation');
            return;
        }

        // Temporarily hide toolbar and auto-save indicator for clean PDF
        const toolbar = document.querySelector('.toolbar');
        const autoSaveIndicator = document.getElementById('autoSaveIndicator');
        toolbar.style.display = 'none';
        autoSaveIndicator.style.display = 'none';

        // Ensure the page content is fully rendered before PDF generation
        await new Promise(resolve => setTimeout(resolve, 100));

        const element = document.querySelector('.form-container');
        const options = {
            margin: 10,
            filename: 'demande_sortie_scolaire.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, logging: true, dpi: 192, letterRendering: true },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        html2pdf().set(options).from(element).save().then(() => {
            // Restore toolbar and auto-save indicator after PDF generation
            toolbar.style.display = 'block';
            autoSaveIndicator.style.display = 'block';
            showMessage('PDF exporté avec succès !', 'success');
        }).catch(error => {
            console.error("Error generating PDF:", error);
            showMessage('Erreur lors de la génération du PDF.', 'validation');
            // Ensure toolbar is restored even on error
            toolbar.style.display = 'block';
            autoSaveIndicator.style.display = 'block';
        });
    }

    // Make functions globally accessible if they are called from inline HTML
    window.clearForm = clearForm;
    window.saveForm = saveForm;
    window.loadForm = loadForm;
    window.exportToPDF = exportToPDF;
    window.addRow = addRow;
    window.removeRow = removeRow;
    window.updateProgress = updateProgress; // Useful for initial load and debugging

</script>
</body>
</html>
